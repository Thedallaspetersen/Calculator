<script>
/* ========= Free analytics with CountAPI =========
   Tracks visits (total/unique), re-visits, daily uniques,
   and Calculate clicks (total/unique). No popups, no cookies. */

const NS   = encodeURIComponent(location.hostname || 'localdev');
const KEY  = (k)=> `${NS}/${k}`;
const K = {
  VISITS_TOTAL: 'visits_total',
  VISITS_UNIQ : 'visits_unique',
  VISITS_DU   : 'visits_daily_unique',
  REVISITS    : 'revisits_total',
  CALC_TOTAL  : 'calc_total',
  CALC_UNIQ   : 'calc_unique'
};
const F = {
  VISITED_ONCE : 'bwi_visited_once',
  LAST_VISIT_D : 'bwi_last_visit_date',
  CALC_ONCE    : 'bwi_calc_once'
};

// Helpers
async function capiHit(k){ 
  try{ await fetch(`https://api.countapi.xyz/hit/${KEY(k)}`, {cache:'no-store'}); }catch{} 
}
async function capiGet(k){ 
  try{ 
    const r=await fetch(`https://api.countapi.xyz/get/${KEY(k)}`,{cache:'no-store'}); 
    if(!r.ok) return null; 
    const {value}=await r.json(); 
    return value??null; 
  }catch{ return null; } 
}
const todayStr = ()=>{ 
  const d=new Date(); 
  const p=n=>String(n).padStart(2,'0'); 
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; 
};

// Track visits automatically
(async function trackVisits(){
  // Always count a visit
  capiHit(K.VISITS_TOTAL);

  const today = todayStr();

  // All-time unique
  if(!localStorage.getItem(F.VISITED_ONCE)){
    await capiHit(K.VISITS_UNIQ);
    localStorage.setItem(F.VISITED_ONCE,'1');
  } else {
    // Revisit
    capiHit(K.REVISITS);
  }

  // Daily unique
  const last = localStorage.getItem(F.LAST_VISIT_D);
  if(last !== today){
    await capiHit(K.VISITS_DU);
    localStorage.setItem(F.LAST_VISIT_D, today);
  }

  // If #admin is in URL, show panel
  if(location.hash === '#admin'){ renderAdmin(); showAdmin(true); }
})();

// Track Calculate button success
async function trackCalculate(){
  capiHit(K.CALC_TOTAL);
  if(!localStorage.getItem(F.CALC_ONCE)){
    await capiHit(K.CALC_UNIQ);
    localStorage.setItem(F.CALC_ONCE, '1');
  }
}

// Admin panel logic
async function renderAdmin(){
  const [vt,vu,rv,du,ct,cu] = await Promise.all([
    capiGet(K.VISITS_TOTAL), capiGet(K.VISITS_UNIQ),
    capiGet(K.REVISITS),     capiGet(K.VISITS_DU),
    capiGet(K.CALC_TOTAL),   capiGet(K.CALC_UNIQ)
  ]);
  const set=(id,val)=>{ 
    const el=document.getElementById(id); 
    if(el) el.textContent = (val??0).toString(); 
  };
  set('a_vt',vt); set('a_vu',vu); set('a_rv',rv); set('a_du',du); set('a_ct',ct); set('a_cu',cu);
}
function showAdmin(on){
  const p=document.getElementById('bwiAdmin'); if(!p) return;
  p.style.display = on ? 'block' : 'none';
}
window.addEventListener('hashchange', ()=>{
  if(location.hash === '#admin'){ renderAdmin(); showAdmin(true); }
  else{ showAdmin(false); }
});
</script>