NEEW

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>5-STEP CALCULATOR – @TheDallasPetersen</title>
<meta name="description" content="Built With Intention: Macro & Timeline Calculator. Estimate protein, calories, weekly fat-loss, and the exact date you’ll reach your goal.">
<style>
  :root{
    --bg:#0f0f12; --card:#17171b; --ink:#e8e8f3; --muted:#a7a7b3;
    --accent:#ff3b30; --ok:#2ecc71; --chip:#1b1b21;
    --hl:#97c9ff; --hl-strong:#1e90ff;
    --line:#26262c; --radius:16px;
    --shadow:0 6px 24px rgba(0,0,0,.28);
    --pro:#4da3ff; --pro-2:#8cc6ff; --ring: color-mix(in srgb, var(--pro), transparent 80%);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.4}
  header{padding:28px 18px 16px;text-align:center;position:relative}
  header::after{content:"";display:block;height:3px;max-width:980px;margin:14px auto 0;border-radius:3px;background:linear-gradient(90deg,var(--accent),#ff7f50 40%,var(--hl-strong));opacity:.5}
  .title{margin:0;font-size:clamp(1.6rem,2.8vw,2rem);letter-spacing:.6px;font-weight:900}
  .yt{margin-top:8px;display:inline-flex;gap:10px;align-items:center;justify-content:center}
  .pill{display:inline-flex;align-items:center;gap:10px;padding:8px 16px;border:1px solid var(--line);border-radius:999px;background:linear-gradient(180deg,#1f1f23,#17171b);box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 6px 16px rgba(0,0,0,.28);transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;text-decoration:none;}
  .pill:hover{transform:translateY(-1px);border-color:#41414a;box-shadow:inset 0 1px 0 rgba(255,255,255,.08), 0 10px 22px rgba(0,0,0,.36)}
  .pill span{font-weight:800;color:#eaeaf2}
  .pill:hover span{color:#ffb3b3}
  .ytmark{width:22px;height:22px;display:block}
  header p{margin:.45rem 0 0;color:var(--muted);max-width:800px;margin-inline:auto}

  .wrap{max-width:980px;margin:0 auto;padding:12px}
  .grid{display:grid;gap:12px}
  @media(min-width:880px){ .grid{grid-template-columns:1fr 1fr} }

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 10px;font-size:1.05rem;letter-spacing:.3px}
  label{display:block;margin:.35rem 0 .25rem;color:var(--muted);font-size:.9rem}
  input, select{width:100%;padding:12px;border-radius:12px;border:1px solid #2a2a31;background:#121217;color:var(--ink);outline:none;transition:border .15s ease, box-shadow .15s ease;}
  input:focus, select:focus{border-color:var(--hl-strong);box-shadow:0 0 0 3px color-mix(in srgb,var(--hl-strong),transparent 80%)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  .bf-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
  @media(min-width:640px){ .bf-grid{grid-template-columns:repeat(3,1fr)} }
  @media(min-width:880px){ .bf-grid{grid-template-columns:repeat(5,minmax(130px,1fr));gap:10px} }
  .bf-tile{position:relative;background:#121217;border:1px solid #2a2a31;border-radius:14px;overflow:hidden;cursor:pointer;transition:.18s transform,.18s border,.18s box-shadow;}
  .bf-tile:hover{transform:translateY(-2px);border-color:var(--hl);box-shadow:0 6px 18px rgba(0,0,0,.28)}
  .bf-tile.active{border:2px solid var(--hl-strong);box-shadow:0 0 0 4px color-mix(in srgb,var(--hl-strong),transparent 72%)}
  .bf-img{display:block;width:100%;height:auto;aspect-ratio:4/5;object-fit:cover;object-position:center 45%;background:#0f0f12;transition:transform .18s ease, filter .18s ease;}
  @media(min-width:880px){ .bf-img{aspect-ratio:5/6;object-position:center 47%} }
  .bf-tile:hover .bf-img{transform:scale(1.02);filter:contrast(1.03) saturate(1.02)}
  .bf-label{position:absolute;left:8px;bottom:8px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(16,16,21,.8),rgba(10,10,14,.8));color:#fff;font-weight:800;font-size:.78rem;letter-spacing:.15px;pointer-events:none;}

  .hint{margin:.35rem 0 0;color:var(--muted);font-size:.85rem}
  .btn{width:100%;margin-top:12px;padding:14px;border-radius:12px;border:0;background:var(--accent);color:#fff;font-weight:900;cursor:pointer;letter-spacing:.2px}
  .btn:focus{outline:3px solid color-mix(in srgb,var(--accent),transparent 70%)}

  .card h3 { font-size: 1rem; letter-spacing: .35px; color: var(--muted); }

  .theday{margin-top:6px;padding:18px 16px;border-radius:16px;background:linear-gradient(180deg,#0d0d12,#0f1016);border:1px solid #2a2a31;box-shadow:0 1px 0 rgba(255,255,255,.04) inset;position:relative;overflow:hidden;text-align:center;}
  .theday::before{content:"";position:absolute;inset:-1px;border-radius:18px;background:linear-gradient(180deg, rgba(77,163,255,.25), rgba(77,163,255,0)) border-box;-webkit-mask: linear-gradient(#000 0 0) padding-box, linear-gradient(#000 0 0) border-box;-webkit-mask-composite: xor; mask-composite: exclude;border:1px solid transparent;pointer-events:none;}
  .theday .lbl{display:inline-block;font-size:.78rem;font-weight:900;letter-spacing:.12em;text-transform:uppercase;color:var(--pro-2);background:rgba(77,163,255,.08);border:1px solid rgba(77,163,255,.25);padding:4px 8px;border-radius:999px;}
  .theday time{display:block;margin-top:10px;font-weight:1000;font-size:clamp(1.35rem,3.2vw,1.8rem);letter-spacing:.2px;}
  .actions{margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  .action-btn,.action-link{padding:10px 12px;border-radius:12px;border:1px solid #2a2a31;background:linear-gradient(180deg,#16161b,#121217);font-weight:900;font-size:.92rem;color:#eaeaf2;text-decoration:none;transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;}
  .action-btn:hover,.action-link:hover{border-color:#3a3a44;box-shadow:0 8px 20px rgba(0,0,0,.25);transform:translateY(-1px);}

  .kpi{display:grid;gap:10px;grid-template-columns:repeat(2,1fr);margin-top:12px}
  @media(min-width:880px){ .kpi{grid-template-columns:repeat(3,1fr)} }
  .tile{background:#121217;border:1px solid #2a2a31;border-radius:12px;padding:12px;text-align:center}
  .tile span{display:block;font-size:.78rem;font-weight:800;letter-spacing:.25px;color:var(--muted)}
  .tile b{display:block;margin-top:6px;font-size:1.35rem;font-weight:1000}
  .tile small{display:block;margin-top:4px;color:#8fa0b6;font-size:.72rem}
  .tile.tracker{position:relative;cursor:pointer;padding:16px;border:1px solid transparent;background:linear-gradient(180deg,#16161b,#121217) padding-box,linear-gradient(90deg,var(--accent),#ff7f50 40%,var(--pro)) border-box;font-weight:1000;display:flex;align-items:center;justify-content:center;min-height:64px}
  .tile.tracker .label{font-size:1.1rem;letter-spacing:.25px;color:#eaeaf2}
  .tile.tracker:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.25)}

  /* NEW: Training tile (full width) */
  .tile.training{
    position:relative;cursor:pointer;padding:16px;border:1px solid transparent;
    background:linear-gradient(180deg,#16161b,#121217) padding-box,
               linear-gradient(90deg,#a78bfa,#7dd3fc 40%,#4da3ff) border-box;
    font-weight:1000;display:flex;align-items:center;justify-content:center;min-height:64px;
    grid-column:1 / -1; /* span entire KPI width */
  }
  .tile.training .label{font-size:1.1rem;letter-spacing:.25px;color:#eaeaf2}
  .tile.training:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.25)}

  .error{border-color:#ff6565 !important;box-shadow:0 0 0 3px rgba(255,101,101,.18) !important}
  .errors{margin-top:10px;color:#ff9a9a;font-size:.92rem}
  footer{padding:28px;text-align:center;color:#a7a7b3;font-size:.85rem}
  #confettiCanvas{position:fixed;inset:0;pointer-events:none;z-index:999}
  .sheet{position:fixed;inset:0;display:none;place-items:end center;background:rgba(0,0,0,.35);z-index:9999}
  .sheet .panel{width:min(520px,92vw);margin:18px;background:#15151a;border:1px solid #2a2a31;border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
  .sheet h4{margin:4px 8px 10px;color:#cfd3df;font-size:.95rem;font-weight:900;letter-spacing:.3px}
  .sheet .rowbtns{display:grid;gap:8px;grid-template-columns:1fr 1fr}
  .sheet button{width:100%;padding:12px;border-radius:12px;border:1px solid #2a2a31;cursor:pointer;background:linear-gradient(180deg,#16161b,#121217);color:#eaeaf2;font-weight:900;font-size:.95rem}
  .sheet .close{margin-top:8px;width:100%;background:#25252c}
  .sheet .fields{display:grid;gap:8px;margin:8px}
  .sheet select{width:100%;padding:12px;border-radius:12px;border:1px solid #2a2a31;background:#121217;color:var(--ink);outline:none}
</style>
</head>
<body>
<header>
  <h1 class="title">5-STEP CALCULATOR</h1>
  <div class="yt">
    <a class="pill" href="https://www.youtube.com/@thedallaspetersen" target="_blank" rel="noopener">
      <svg class="ytmark" viewBox="0 0 64 64" aria-hidden="true">
        <defs>
          <radialGradient id="ytr" cx="50%" cy="35%" r="75%">
            <stop offset="0%"  stop-color="#ff6a6a"/>
            <stop offset="60%" stop-color="#ff0000"/>
            <stop offset="100%" stop-color="#c80000"/>
          </radialGradient>
        </defs>
        <rect x="4" y="14" width="56" height="36" rx="12" fill="url(#ytr)"/>
        <rect x="4" y="14" width="56" height="36" rx="12" fill="transparent"
              style="filter:drop-shadow(0 4px 10px rgba(0,0,0,.45))"/>
        <path d="M28 24l14 8-14 8z" fill="#fff"/>
      </svg>
      <span>@TheDallasPetersen</span>
    </a>
  </div>
  <p>Answer a few questions. We’ll estimate protein, calories, weekly loss, and the exact date you’ll reach your goal.</p>
</header>

<div class="wrap grid">
  <!-- LEFT: inputs -->
  <section class="card" aria-labelledby="aboutTitle">
    <h3 id="aboutTitle">About you</h3>
    <div class="row">
      <div>
        <label for="age">Age</label>
        <input id="age" type="number" inputmode="numeric" placeholder="age" min="13" max="90" step="1">
      </div>
      <div>
        <label for="sex">Sex</label>
        <select id="sex">
          <option value="" selected>Select…</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="heightUnit">Height</label>
        <select id="heightUnit">
          <option value="ftin" selected>feet/inches</option>
          <option value="cm">centimeters</option>
        </select>
        <div class="row" id="ftin">
          <input id="ft" type="number" inputmode="numeric" placeholder="ft" min="3" max="8" step="1">
          <input id="inch" type="number" inputmode="numeric" placeholder="in" min="0" max="11" step="1">
        </div>
        <input id="cm" type="number" inputmode="numeric" placeholder="cm" style="display:none;margin-top:8px" min="120" max="230" step="0.1">
      </div>
      <div>
        <label for="weight">Weight</label>
        <div class="row">
          <input id="weight" type="number" inputmode="numeric" placeholder="weight" min="70" max="500" step="1">
          <select id="wUnit"><option value="lb" selected>lb</option><option value="kg">kg</option></select>
        </div>
      </div>
    </div>

    <h3 style="margin-top:16px">When will you start?</h3>
    <input id="startDate" type="date" aria-label="Start date">

    <h3 style="margin-top:16px">Activity</h3>
    <label for="work">Work Activity</label>
    <select id="work">
      <option value="light" selected>Light Activity – Desk</option>
      <option value="moderate">Moderate Activity – Retail/Service</option>
      <option value="high">High Activity – Labor</option>
    </select>

    <!-- clarify session length -->
    <label style="margin-top:8px" for="training">
      Training (gym) <span style="font-size:.82em; color:var(--muted)">~45 min per session</span>
    </label>
    <select id="training">
      <option value="0">No training</option>
      <option value="1-2">1–2 sessions/week</option>
      <option value="3-4" selected>3–4 sessions/week</option>
      <option value="5-6">5–6 sessions/week</option>
    </select>

    <label style="margin-top:8px" for="cardio">Cardio (hours/week)</label>
    <select id="cardio">
      <option value="0" selected>None</option>
      <option value="1-2">1–2 hours</option>
      <option value="3-4">3–4 hours</option>
      <option value="5-6">5–6 hours</option>
    </select>

    <div id="bfSection" style="display:none">
      <h3 style="margin-top:12px">Pick your current look (body-fat approximation)</h3>
      <div id="bfCurrent" class="bf-grid" role="radiogroup" aria-label="Current body fat"></div>

      <h3 style="margin-top:12px">Pick your goal look</h3>
      <div id="bfGoal" class="bf-grid" role="radiogroup" aria-label="Goal body fat"></div>
    </div>

    <button class="btn" id="calc">Calculate</button>
    <div class="errors" id="errors" aria-live="polite"></div>
  </section>

  <!-- RIGHT: results -->
  <section class="card" aria-live="polite">
    <h3>Your Plan</h3>

    <div class="theday" id="theDay" style="display:none">
      <span class="lbl">Finish line</span>
      <time id="theDayDate">—</time>

      <div class="actions" id="dayActions" style="display:none">
        <button class="action-btn" id="copyDateBtn" type="button">Copy date</button>
        <a class="action-link" id="gcalLink" target="_blank" rel="noopener">Google Calendar</a>
      </div>

      <div class="finish-stripe" aria-hidden="true"></div>
    </div>

    <div class="kpi" id="kpi" style="display:none">
      <div class="tile"><span>Goal Weight (est.)</span><b id="kGoalWt">—</b></div>
      <div class="tile"><span>Weeks to goal</span><b id="kWeeks">—</b></div>
      <div class="tile"><span>Calories / day</span><b id="kCals">—</b></div>
      <div class="tile"><span>Protein (g/day)</span><b id="kProtein">—</b><small id="kProteinEq" aria-hidden="true"></small></div>
      <div class="tile"><span>Weekly Loss (lb)</span><b id="kWeeklyLoss">—</b></div>
      <div class="tile tracker" id="trackerTile"><span class="label">Tracker</span></div>
      <!-- NEW: full-width training tile -->
      <div class="tile training" id="trainingTile"><span class="label">Create Training Plan</span></div>
    </div>

    <div class="hint" id="proteinFoot" style="display:none">Protein set from lean mass & deficit (evidence-based range).</div>
    <div class="errors" id="errorsR" style="display:none"></div>
  </section>
</div>

<footer>© Built With Intention • Educational estimates only</footer>

<!-- Action sheet (existing) -->
<div class="sheet" id="sheet">
  <div class="panel">
    <h4>Export Tracker</h4>
    <div class="rowbtns">
      <button id="btnPDF" type="button">Checkpoints</button>
      <button id="btnNotes" type="button">Copy for Notes</button>
    </div>
    <button class="close" id="btnClose" type="button">Close</button>
  </div>
</div>

<!-- NEW: Training sheet (asks ONLY equipment + experience; no prompt shown) -->
<div class="sheet" id="trainingSheet">
  <div class="panel">
    <h4>Create Training Plan</h4>
    <div class="fields">
      <label for="equipSelect">Equipment</label>
      <select id="equipSelect">
        <option value="full gym" selected>Full gym</option>
        <option value="dumbbells">Dumbbells</option>
        <option value="bodyweight">Bodyweight</option>
      </select>

      <label for="expSelect" style="margin-top:6px;">Experience level</label>
      <select id="expSelect">
        <option value="beginner" selected>Beginner</option>
        <option value="intermediate">Intermediate</option>
        <option value="experienced">Experienced</option>
      </select>
    </div>
    <div class="rowbtns" style="margin:8px">
      <button id="btnCopyPrompt" type="button">Copy Prompt</button>
      <button class="close" id="btnCloseTraining" type="button">Close</button>
    </div>
  </div>
</div>

<canvas id="confettiCanvas"></canvas>

<script>
/* ---------- IMAGE SETS & LABELS ---------- */
const bfPicsMale=[{pct:0.09,label:'8–10%',img:'MaleBody8.jpeg',alt:'Male 8–10%'},{pct:0.115,label:'11–12%',img:'MaleBody10.jpeg',alt:'Male 11–12%'},{pct:0.135,label:'13–14%',img:'MaleBody13.jpeg',alt:'Male 13–14%'},{pct:0.16,label:'15–17%',img:'MaleBody15.jpeg',alt:'Male 15–17%'},{pct:0.185,label:'18–19%',img:'MaleBody18.jpeg',alt:'Male 18–19%'},{pct:0.21,label:'20–22%',img:'MaleBody20.jpeg',alt:'Male 20–22%'},{pct:0.235,label:'23–24%',img:'MaleBody25.jpeg',alt:'Male 23–24%'},{pct:0.27,label:'25–29%',img:'MaleBody30.jpeg',alt:'Male 25–29%'},{pct:0.32,label:'30–34%',img:'MaleBody35.jpeg',alt:'Male 30–34%'},{pct:0.375,label:'35–40%',img:'MaleBody40.jpeg',alt:'Male 35–40%'}];
const bfPicsFemale=[{pct:0.135,label:'13–14%',img:'FemaleBody1.jpeg',alt:'Female 13–14%'},{pct:0.155,label:'15–16%',img:'FemaleBody2.jpeg',alt:'Female 15–16%'},{pct:0.175,label:'17–18%',img:'FemaleBody3.jpeg',alt:'Female 17–18%'},{pct:0.195,label:'19–20%',img:'FemaleBody4.jpeg',alt:'Female 19–20%'},{pct:0.215,label:'21–22%',img:'FemaleBody5.jpeg',alt:'Female 21–22%'},{pct:0.235,label:'23–24%',img:'FemaleBody6.jpeg',alt:'Female 23–24%'},{pct:0.265,label:'25–28%',img:'FemaleBody7.jpeg',alt:'Female 25–28%'},{pct:0.305,label:'29–32%',img:'FemaleBody8.jpeg',alt:'Female 29–32%'},{pct:0.345,label:'33–36%',img:'FemaleBody9.jpeg',alt:'Female 33–36%'},{pct:0.39,label:'37–41%',img:'FemaleBody10.jpeg',alt:'Female 37–41%'}];

/* ---------- helpers ---------- */
const $=id=>document.getElementById(id);
const round=(x,n=0)=>{const p=10**n;return Math.round(x*p)/p;};
function formatLongDate(dt){return dt.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});}

/* Default start date */
(function setDefaultStartToday(){
  const el=$('startDate'); if(!el.value){const now=new Date(); const pad=n=>String(n).padStart(2,'0'); el.value=`${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;}
})();

/* Build BF photo grids */
function buildBFGrid(containerId,sex){
  const list=(sex==='female')?bfPicsFemale:bfPicsMale;
  const wrap=$(containerId); wrap.innerHTML='';
  list.forEach((o)=>{
    const card=document.createElement('button'); card.type='button'; card.className='bf-tile'; card.dataset.value=o.pct; card.setAttribute('role','radio'); card.setAttribute('aria-checked','false');
    const img=document.createElement('img'); img.src=o.img; img.alt=o.alt; img.className='bf-img'; img.loading='lazy';
    const lab=document.createElement('div'); lab.className='bf-label'; lab.textContent=o.label;
    card.appendChild(img); card.appendChild(lab);
    card.onclick=()=>{[...wrap.children].forEach(c=>{c.classList.remove('active'); c.setAttribute('aria-checked','false');}); card.classList.add('active'); card.setAttribute('aria-checked','true');};
    wrap.appendChild(card);
  });
}
function getSelected(containerId){const a=$(containerId).querySelector('.active'); return a?Number(a.dataset.value):null;}
$('heightUnit').onchange=()=>{const cmMode=$('heightUnit').value==='cm'; $('ftin').style.display=cmMode?'none':'grid'; $('cm').style.display=cmMode?'block':'none';};
function refreshPickers(){
  const sex=$('sex').value;
  if(!sex){$('bfSection').style.display='none'; $('bfCurrent').innerHTML=''; $('bfGoal').innerHTML=''; return;}
  buildBFGrid('bfCurrent',sex); buildBFGrid('bfGoal',sex); $('bfSection').style.display='block';
}
$('sex').addEventListener('change',refreshPickers);
document.addEventListener('DOMContentLoaded',()=>{ if($('sex').value) refreshPickers(); });
window.addEventListener('pageshow',(e)=>{ if(e.persisted||document.readyState==='complete'){ if($('sex').value&&(!$('bfCurrent').children.length||!$('bfGoal').children.length)){refreshPickers();}}});

/* --- Energy model helpers --- */
function activityMultiplier(work,training,cardio){
  let base=1.35; if(work==='moderate') base=1.55; if(work==='high') base=1.75;
  let addGym=0; if(training==='1-2') addGym=0.05; if(training==='3-4') addGym=0.10; if(training==='5-6') addGym=0.15;
  let addCardio=0; if(cardio==='1-2') addCardio=0.05; if(cardio==='3-4') addCardio=0.10; if(cardio==='5-6') addCardio=0.12;
  const total=base+addGym+addCardio; return Math.min(2.1,total);
}
function bmr(sex,kg,cm,age){return sex==='male'?(10*kg+6.25*cm-5*age+5):(10*kg+6.25*cm-5*age-161);}

/* --- Validation helpers --- */
function markError(el,cond){ if(!el) return; el.classList.toggle('error',!!cond); }
function validateInputs(){
  const errors=[]; const ageEl=$('age'), sexEl=$('sex'), startEl=$('startDate');
  const heightMode=$('heightUnit').value; const ftEl=$('ft'), inEl=$('inch'), cmEl=$('cm'); const weightEl=$('weight');
  [ageEl,sexEl,startEl,ftEl,inEl,cmEl,weightEl].forEach(el=>el.classList.remove('error'));
  if(!sexEl.value){errors.push('Select your sex.'); markError(sexEl,true);}
  const age=Number(ageEl.value||0);
  if(!age){errors.push('Enter your age.'); markError(ageEl,true);}
  else if(age<13){errors.push('Age must be 13 or older.'); markError(ageEl,true);}
  else if(age>90){errors.push('Age cannot be over 90.'); markError(ageEl,true);}
  let cm=0;
  if(heightMode==='cm'){cm=Number(cmEl.value||0); if(!cm){errors.push('Enter your height in centimeters.'); markError(cmEl,true);}}
  else{const ft=Number(ftEl.value||0), inch=Number(inEl.value||0); if(!ft&&!inch){errors.push('Enter your height in feet and inches.'); markError(ftEl,true); markError(inEl,true);} else cm=(ft*12+inch)*2.54;}
  const weight=Number(weightEl.value||0); if(!weight){errors.push('Enter your weight.'); markError(weightEl,true);}
  if(!startEl.value){errors.push('Choose your start date.'); markError(startEl,true);}
  const cur=getSelected('bfCurrent'); const goal=getSelected('bfGoal');
  if(!cur){errors.push('Pick your current body-fat look.');}
  if(!goal){errors.push('Pick your goal body-fat look.');}
  if(cur&&goal&&goal>=cur){errors.push('Goal body-fat must be lower than current.');}
  return {errors,cm,age,weight,cur,goal};
}
function toYMD(d){return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`}

/* ---- Confetti ---- */
const Confetti=(()=>{const canvas=$('confettiCanvas');const ctx=canvas.getContext('2d');let w=0,h=0,pieces=[],rafId=null,endTime=0;
  function resize(){w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;}
  function rand(a,b){return a+Math.random()*(b-a);}
  function burst(){const n=140; pieces=new Array(n).fill(0).map(()=>({x:w/2+rand(-80,80),y:h/3+rand(-40,40),r:rand(2,4),a:rand(0,2*Math.PI),vx:rand(-3,3),vy:rand(-6,-2),g:rand(0.08,0.14),s:rand(0.01,0.03),col:Math.random()<0.5?'#8cc6ff':'#4da3ff'})); endTime=performance.now()+1200; if(!rafId) tick();}
  function tick(){rafId=requestAnimationFrame(tick); const now=performance.now(); if(window.matchMedia('(prefers-reduced-motion: reduce)').matches){ctx.clearRect(0,0,w,h); cancelAnimationFrame(rafId); rafId=null; return;} ctx.clearRect(0,0,w,h); pieces.forEach(p=>{p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.a+=p.s; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.col; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();}); pieces=pieces.filter(p=>p.y<h+20); if(now>endTime&&pieces.length===0){cancelAnimationFrame(rafId); rafId=null;}}
  window.addEventListener('resize',resize,{passive:true}); resize(); return {burst};
})();

/* =================== TRACKER / EXPORT HELPERS =================== */
function parsePctRange(label){ if(!label) return null; const clean=String(label).replace(/\s+/g,'').replace('–','-'); const m=clean.match(/(\d+)-(\d+)%/); if(!m) return null; return {min:Number(m[1])/100,max:Number(m[2])/100}; }
function getPicSet(sex){return(sex==='female')?bfPicsFemale:bfPicsMale;}

function buildWeeklyPlan({startDT,startLb,goalLb,weeksRounded,bfCur,bfGoal}){
  const perWeekLoss=(startLb-goalLb)/weeksRounded; const weeks=[];
  for(let w=1;w<=weeksRounded;w++){const wkStart=new Date(startDT.getTime()+(w-1)*7*24*60*60*1000); const targetLb=Math.max(goalLb,startLb-perWeekLoss*w); const bfEst=bfCur+(bfGoal-bfCur)*(w/weeksRounded);
    weeks.push({week:w,startNice:wkStart.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}),targetLb:Math.round(targetLb*10)/10,bfEst});}
  return weeks;
}
function findMilestones({sex,bfCur,bfGoal,weeks}){
  const tol=0.002; const pics=getPicSet(sex);
  const bins=pics.map(p=>{const r=parsePctRange(p.label); return r?{label:p.label,img:p.img,alt:p.alt,lower:r.min,upper:r.max,mid:p.pct}:null;}).filter(Boolean);
  const traversed=bins.filter(b=>b.lower<=bfCur&&b.upper>=bfGoal);
  const milestones=[]; const seen=new Set();
  for(const b of traversed){
    for(let i=0;i<weeks.length;i++){const cur=weeks[i].bfEst; const prev=(i===0)?bfCur:weeks[i-1].bfEst;
      if(prev>(b.lower+tol)&&cur<=(b.lower+tol)){milestones.push({week:weeks[i].week,label:b.label,img:b.img,alt:b.alt}); seen.add(b.label); break;}}
  }
  let goalBin=bins.find(b=>bfGoal<=b.upper&&bfGoal>=b.lower);
  if(!goalBin){goalBin=bins.reduce((best,b)=>{const dBest=Math.abs(best.mid-bfGoal); const dCur=Math.abs(b.mid-bfGoal); return dCur<dBest?b:best;},bins[0]);}
  if(goalBin&&!seen.has(goalBin.label)){milestones.push({week:weeks[weeks.length-1].week,label:goalBin.label+' (Final Goal)',img:goalBin.img,alt:goalBin.alt});}
  milestones.sort((a,b)=>a.week-b.week); return milestones;
}

/* ======= VIEW-ONLY CHECKPOINTS ======= */
function openTrackerPDF({summary,milestones,sex,startLabel}){
  const w=window.open('','_blank'); if(!w){alert('Popup blocked. Please allow popups for Checkpoints.'); return;}
  const futureMilestones=(milestones||[]).filter(m=>!startLabel||m.label!==startLabel);
  const css=`:root{--ink:#0f0f12;--muted:#5f6675;--line:#e9ecf2;--grad:linear-gradient(90deg,#ff3b30,#ff7f50 40%,#4da3ff);}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);}
  .page{max-width:980px;margin:0 auto;padding:28px;} header h1{margin:0 0 6px;font-size:26px;font-weight:1000;letter-spacing:.2px;}
  .stripe{height:3px;border-radius:3px;background:var(--grad);opacity:.9;margin:8px 0 18px;}
  .card{border:1px solid var(--line);border-radius:14px;padding:14px 16px;background:#fff;}
  .summary{display:grid;gap:10px 18px;grid-template-columns:repeat(2,1fr);}
  .row b{display:block;font-size:12px;letter-spacing:.25px;color:#70788a;text-transform:uppercase;}
  .row span{display:block;margin-top:2px;font-size:14px;}
  h2{margin:18px 0 10px;font-size:15px;font-weight:1000;letter-spacing:.35px;color:#3e4656;text-transform:uppercase;}
  .gallery{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));align-items:start;}
  .tile{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 4px 16px rgba(0,0,0,.06);}
  .thumb{display:block;width:100%;height:auto;aspect-ratio:4/5;object-fit:cover;}
  .meta{padding:10px 12px;} .cap{font-weight:900;font-size:14px;} .sub{color:#7a8396;font-size:12px;margin-top:3px;}
  .goal .tile{outline:2px solid rgba(77,163,255,.6);box-shadow:0 6px 22px rgba(77,163,255,.16);}
  .empty{color:#7a8396;padding:12px 0 4px;} @media print{@page{size:auto;margin:12mm} body{background:#fff}}`;
  const summaryHTML=`<div class="card"><div class="summary">
      <div class="row"><b>Start Date</b><span>${summary.startNice}</span></div>
      <div class="row"><b>Finish Line</b><span>${summary.finishNice}</span></div>
      <div class="row"><b>Total Weeks</b><span>${summary.totalWeeks}</span></div>
      <div class="row"><b>Goal Weight</b><span>${summary.goalLb} lb</span></div>
    </div></div>`;
  const galleryHTML=futureMilestones.length?futureMilestones.map(m=>`<figure class="${/Final Goal/.test(m.label)?'goal':''}">
      <div class="tile"><img class="thumb" src="${m.img}" alt="${m.alt}" loading="eager">
      <figcaption class="meta"><div class="cap">${m.label.replace(' (Final Goal)','')}</div>
      <div class="sub">Week ${m.week}${/Final Goal/.test(m.label)?' • Final Goal':''}</div></figcaption></div></figure>`).join('')
    :`<div class="empty">No future checkpoints available yet. Calculate your plan to generate them.</div>`;
  const html=`<html><head><meta charset="utf-8"><title>Checkpoints</title><meta name="color-scheme" content="light only"><style>${css}</style></head>
    <body><div class="page"><header><h1>CHECKPOINTS</h1><div class="stripe"></div></header>${summaryHTML}
    <h2>Milestone Photos</h2><section class="gallery">${galleryHTML}</section></div></body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
}

/* Copy-only Notes (unchanged) */
async function copyTrackerNotes({summary,weeks,choices}){
  const noYear=s=>String(s).replace(/,\s*\d{4}/,'');
  const lines=[];
  lines.push('CUT TRACKER');
  lines.push('────────────────────────');
  lines.push(`Start Date: ${summary.startNice}`);
  lines.push(`Finish Line: ${summary.finishNice}`);
  lines.push(`Total Weeks: ${summary.totalWeeks}`);
  lines.push(`Start Weight: ${summary.startLb} lb`);
  lines.push(`Goal Weight: ${summary.goalLb} lb`);
  lines.push(`Calories/day: ${summary.cals}`);
  lines.push(`Protein/day: ${summary.protein} g`);
  lines.push('');
  lines.push('ACTIVITY SELECTIONS');
  lines.push('────────────────────────');
  lines.push(`Work Activity: ${choices.work}`);
  lines.push(`Training: ${choices.training} (~45-min sessions)`);
  lines.push(`Cardio: ${choices.cardio}`);
  lines.push('');
  lines.push('WEEKLY LOG');
  lines.push('────────────────────────');
  weeks.forEach(w=>{const shortDate=noYear(w.startNice); lines.push(`Week ${w.week} — ${shortDate} • Goal: ${w.targetLb} lb`); lines.push('');});
  const txt=lines.join('\n');
  try{await navigator.clipboard.writeText(txt); alert('Tracker copied. Open Notes and paste!');}
  catch(e){const ta=document.createElement('textarea'); ta.value=txt; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select();
    try{document.execCommand('copy'); alert('Tracker copied. Open Notes and paste!');}
    catch(err){alert('Copy failed. Long-press to paste from here:\n\n'+txt);}
    finally{document.body.removeChild(ta);}
  }
}

/* =================== MAIN CALCULATE =================== */
let _trackerData=null;

$('calc').onclick=()=>{
  const v=validateInputs(); const errsBox=$('errors');
  if(v.errors.length){
    errsBox.innerHTML='Please fix the following:<ul><li>'+v.errors.join('</li><li>')+'</li></ul>';
    $('kpi').style.display='none'; $('proteinFoot').style.display='none'; $('theDay').style.display='none'; $('dayActions').style.display='none';
    document.querySelector('section.card').scrollIntoView({behavior:'smooth'}); return;
  } else { errsBox.innerHTML=''; }

  const age=Number($('age').value||0);
  const sex=$('sex').value;
  const cm=v.cm;
  let kg=Number($('weight').value||0); if($('wUnit').value==='lb') kg=kg*0.45359237;
  const lb=kg/0.45359237;
  const mult=activityMultiplier($('work').value,$('training').value,$('cardio').value);

  const startVal=$('startDate').value;
  const startDT=startVal?new Date(startVal+'T00:00:00'):new Date();

  const bfCur=v.cur, bfGoal=v.goal;

  const _bmr=bmr(sex,kg,cm,age);
  const tdee=_bmr*mult;

  const leanMass_kg=kg*(1-bfCur);
  const goalWeight_kg=leanMass_kg/(1-bfGoal);
  const goalWeight_lb=goalWeight_kg/0.45359237;

  const fatToLose_lb=Math.max(0,lb-goalWeight_lb);
  const weeklyLossTarget_lb=lb*0.01;
  const targetDailyDeficit=(weeklyLossTarget_lb*3500)/7;

  const safetyFloor=(sex==='male')?1600:1300;
  let calories=tdee-targetDailyDeficit; let floorApplied=false;
  if(calories<safetyFloor){calories=safetyFloor; floorApplied=true;}

  const achievableWeeklyLoss_lb=floorApplied?Math.max(0,((tdee-calories)*7)/3500):weeklyLossTarget_lb;
  const weeks=achievableWeeklyLoss_lb>0?fatToLose_lb/achievableWeeklyLoss_lb:0;

  const ffm_lb=lb*(1-bfCur);
  const deficitPctBW=achievableWeeklyLoss_lb/lb;
  let multProt=1.10; if(deficitPctBW>=0.0075) multProt+=0.10; if(deficitPctBW>=0.0125) multProt+=0.05;
  const isLeanMale=(sex==='male'&&bfCur<=0.15); const isLeanFem=(sex==='female'&&bfCur<=0.24);
  if(isLeanMale||isLeanFem) multProt+=0.05;
  const trains3plus=(['3-4','5-6'].includes($('training').value)); if(trains3plus) multProt+=0.05;
  multProt=Math.max(1.00,Math.min(1.30,multProt));
  let protein_g=Math.round(ffm_lb*multProt);
  const proteinFloor=Math.max(90,Math.round(ffm_lb*0.8)); protein_g=Math.max(proteinFloor,protein_g);

  const daysToGoal=Math.ceil(weeks*7);
  const finishDT=new Date(startDT.getTime()+daysToGoal*24*60*60*1000);

  const niceDate=formatLongDate(finishDT);
  $('theDayDate').textContent=niceDate; $('theDay').style.display='block'; $('dayActions').style.display='flex';
  Confetti.burst(); const box=$('theDay'); box.classList.remove('celebrate'); void box.offsetWidth; box.classList.add('celebrate');

  const ymd=toYMD(finishDT); const gStart=ymd, gEnd=toYMD(new Date(finishDT.getTime()+24*60*60*1000));
  const gTitle=encodeURIComponent('Finish Line – Built With Intention'); const gDetails=encodeURIComponent('Estimated date to reach your goal body composition.');
  $('gcalLink').href=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${gTitle}&dates=${gStart}/${gEnd}&details=${gDetails}`;
  $('copyDateBtn').onclick=async()=>{try{await navigator.clipboard.writeText(niceDate); $('copyDateBtn').textContent='Copied!'; setTimeout(()=>{$('copyDateBtn').textContent='Copy date';},1200);} catch(e){alert('Copy failed.');}};

  $('kGoalWt').textContent=`${round(goalWeight_lb,1)} lb`;
  $('kProtein').textContent=protein_g;
  $('kCals').textContent=Math.round(calories);
  $('kWeeks').textContent=Math.max(1,Math.round(weeks));
  $('kWeeklyLoss').textContent=round(achievableWeeklyLoss_lb,1);
  $('kProteinEq').textContent=`≈ FFM(lb) × ${round(multProt,2)}  (${Math.round(ffm_lb)} × ${round(multProt,2)})`;

  $('proteinFoot').style.display='block'; $('kpi').style.display='grid';

  const weeksRounded=Math.max(1,Math.round(weeks));
  const weeksPlan=buildWeeklyPlan({startDT,startLb:lb,goalLb:goalWeight_lb,weeksRounded,bfCur:bfCur,bfGoal:bfGoal});
  const milestones=findMilestones({sex,bfCur,bfGoal,weeks:weeksPlan});

  const _bins=getPicSet(sex).map(p=>{const r=parsePctRange(p.label);return r?{label:p.label,lower:r.min,upper:r.max}:null;}).filter(Boolean);
  const startBin=_bins.find(b=>bfCur>=b.lower&&bfCur<=b.upper);
  const startLabel=startBin?startBin.label:null;

  /* visible text of selections for Notes export */
  const workText=$('work').options[$('work').selectedIndex].text;
  const trainingText=$('training').options[$('training').selectedIndex].text;
  const cardioText=$('cardio').options[$('cardio').selectedIndex].text;

  _trackerData={
    summary:{
      startNice:formatLongDate(startDT),
      finishNice:niceDate,
      totalWeeks:weeksRounded,
      startLb:Math.round(lb),
      goalLb:Math.round(goalWeight_lb),
      cals:Math.round(calories),
      protein:protein_g
    },
    weeks:weeksPlan,
    milestones,
    sex,
    startLabel,
    choices:{work:workText,training:trainingText,cardio:cardioText}
  };
};

/* Action sheet (existing) */
(function initSheet(){
  const sheet=$('sheet');
  const open=()=>{ if(!_trackerData){alert('Calculate your plan first.'); return;} sheet.style.display='grid'; };
  const close=()=>{ sheet.style.display='none'; };
  $('trackerTile').addEventListener('click',open);
  $('btnClose').addEventListener('click',close);
  $('btnPDF').addEventListener('click',()=>{close(); openTrackerPDF(_trackerData);});
  $('btnNotes').addEventListener('click',()=>{close(); copyTrackerNotes(_trackerData);});
})();

/* NEW: Training sheet behavior (no prompt shown to user) */
(function initTraining(){
  const sheet=$('trainingSheet');
  const open=()=>{ if(!_trackerData){alert('Calculate your plan first.'); return;} sheet.style.display='grid'; };
  const close=()=>{ sheet.style.display='none'; };

  $('trainingTile').addEventListener('click',open);
  $('btnCloseTraining').addEventListener('click',close);

  $('btnCopyPrompt').addEventListener('click', async ()=>{
    if(!_trackerData){ alert('Calculate your plan first.'); return; }

    const equip = $('equipSelect').value;                 // Full gym / Dumbbells / Bodyweight
    const exp   = $('expSelect').value;                   // beginner / intermediate / experienced
    const days  = $('training').options[$('training').selectedIndex].text; // e.g., "3–4 sessions/week"
    const { cals, protein } = _trackerData.summary;

    const prompt =
`You are my personal trainer. Create a resistance-training plan for me optimized with the following information.

Context:
- Days per week available: ${days}
- Session length: ~45 minutes
- Equipment: ${equip}
- Experience level: ${exp}
- Daily calories: ${cals}
- Daily protein: ${protein} g

Requirements: 
- Each muscle group should be trained at least twice per week.  
- Workouts should be designed to send a clear “signal” to maintain/grow muscle, not endless junk volume.  
- Keep volume efficient: only the sets needed to send the signal.
- Goal: I am in a calorie deficit. I want to keep and even build muscle while losing the fat.
- Output format ONLY (no explanations): 
Day 1: Exercise — sets × reps
Day 2: …
… (cover the week)`;

    try{
      await navigator.clipboard.writeText(prompt);
      close();
      alert('Copied! Open ChatGPT and paste the prompt to generate your workout plan.');
    }catch(e){
      close();
      alert('Copy failed. After closing, paste this into ChatGPT:\n\n' + prompt);
    }
  });
})();
</script>
</body>
</html>